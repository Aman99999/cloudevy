// CloudEvy Multi-Tenant Database Schema with Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Workspaces (Tenants/Organizations)
model Workspace {
  id                 Int      @id @default(autoincrement())
  name               String   @db.VarChar(255)
  slug               String   @unique @db.VarChar(255)
  subscriptionStatus String   @default("trial") @map("subscription_status") @db.VarChar(50)
  trialEndsAt        DateTime @default(dbgenerated("CURRENT_TIMESTAMP + INTERVAL '14 days'")) @map("trial_ends_at")
  isActive           Boolean  @default(true) @map("is_active")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  users          User[]
  cloudAccounts  CloudAccount[]
  servers        Server[]
  containers     Container[]
  auditLogs      AuditLog[]
  schedules      Schedule[]
  invitations    WorkspaceInvitation[]
  members        WorkspaceMember[]

  @@index([slug])
  @@map("workspaces")
}

// Users (linked to workspaces)
model User {
  id           Int       @id @default(autoincrement())
  workspaceId  Int       @map("workspace_id")
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.VarChar(255)
  fullName     String    @map("full_name") @db.VarChar(255)
  role         String    @default("owner") @db.VarChar(50)
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLoginAt  DateTime? @map("last_login_at")

  // Relations
  workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  auditLogs AuditLog[]
  workspaceMemberships WorkspaceMember[] @relation("UserMemberships")
  sentInvitations WorkspaceInvitation[] @relation("InvitedBy")

  @@index([workspaceId])
  @@index([email])
  @@map("users")
}

// Cloud Accounts (AWS, Azure, GCP connections)
model CloudAccount {
  id          Int      @id @default(autoincrement())
  workspaceId Int      @map("workspace_id")
  provider    String   @db.VarChar(50)
  accountName String   @map("account_name") @db.VarChar(255)
  credentials String?  @db.Text
  region      String?  @db.VarChar(100)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  servers   Server[]

  @@index([workspaceId])
  @@map("cloud_accounts")
}

// Servers (Infrastructure resources)
model Server {
  id               Int           @id @default(autoincrement())
  workspaceId      Int           @map("workspace_id")
  cloudAccountId   Int?          @map("cloud_account_id")
  name             String        @db.VarChar(255)
  ipAddress        String?       @map("ip_address") @db.VarChar(45)
  provider         String?       @db.VarChar(50)
  region           String?       @db.VarChar(100)
  instanceType     String?       @map("instance_type") @db.VarChar(100)
  instanceId       String?       @map("instance_id") @db.VarChar(255)
  apiKey           String?       @unique @map("api_key") @db.VarChar(255)
  status           String        @default("running") @db.VarChar(50)
  agentVersion     String?       @map("agent_version") @db.VarChar(20)
  lastAgentContact DateTime?     @map("last_agent_contact")
  createdAt        DateTime      @default(now()) @map("created_at")
  updatedAt        DateTime      @updatedAt @map("updated_at")

  // Relations
  workspace      Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  cloudAccount   CloudAccount?         @relation(fields: [cloudAccountId], references: [id], onDelete: SetNull)
  containers     Container[]
  schedules      Schedule[]
  networkTraffic NetworkTrafficHourly[]

  @@index([workspaceId])
  @@index([apiKey])
  @@map("servers")
}

// Scheduled Downtime (for server automation)
model Schedule {
  id                     Int       @id @default(autoincrement())
  workspaceId            Int       @map("workspace_id")
  serverId               Int       @map("server_id")
  name                   String    @db.VarChar(255)
  action                 String    @db.VarChar(50)   // 'stop', 'start', 'reboot', 'scale_down', 'scale_up'
  rrule                  String    @db.Text          // RRule string (e.g., 'FREQ=DAILY;BYHOUR=21')
  timezone               String    @db.VarChar(100)  @default("UTC")
  enabled                Boolean   @default(true)
  nextRunAt              DateTime  @map("next_run_at")
  lastRunAt              DateTime? @map("last_run_at")
  executionCount         Int       @default(0) @map("execution_count")
  targetInstanceType     String?   @map("target_instance_type") @db.VarChar(100) // For scale_down/scale_up actions
  originalInstanceType   String?   @map("original_instance_type") @db.VarChar(100) // Store original for scale_up
  // EBS Volume scaling fields
  targetVolumeSize       Int?      @map("target_volume_size") // In GB
  targetVolumeType       String?   @map("target_volume_type") @db.VarChar(50) // gp2, gp3, io1, io2, st1, sc1
  targetVolumeIops       Int?      @map("target_volume_iops") // Provisioned IOPS
  targetVolumeThroughput Int?      @map("target_volume_throughput") // MB/s for gp3
  originalVolumeSize     Int?      @map("original_volume_size")
  originalVolumeType     String?   @map("original_volume_type") @db.VarChar(50)
  originalVolumeIops     Int?      @map("original_volume_iops")
  originalVolumeThroughput Int?    @map("original_volume_throughput")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  // Relations
  workspace  Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  server     Server              @relation(fields: [serverId], references: [id], onDelete: Cascade)
  executions ScheduleExecution[]

  @@index([workspaceId])
  @@index([serverId])
  @@index([enabled])
  @@index([nextRunAt])
  @@map("schedules")
}

// Schedule Execution History
model ScheduleExecution {
  id         Int      @id @default(autoincrement())
  scheduleId Int      @map("schedule_id")
  action     String   @db.VarChar(50)
  status     String   @db.VarChar(50)   // 'success', 'failed'
  errorMsg   String?  @map("error_msg") @db.Text
  duration   Int                         // milliseconds
  executedAt DateTime @default(now()) @map("executed_at")

  // Relations
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([executedAt])
  @@map("schedule_executions")
}

// Containers (Docker/Podman)
model Container {
  id          Int      @id @default(autoincrement())
  workspaceId Int      @map("workspace_id")
  serverId    Int?     @map("server_id")
  containerId String   @map("container_id") @db.VarChar(255)
  name        String   @db.VarChar(255)
  image       String?  @db.VarChar(255)
  status      String?  @db.VarChar(50)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  server    Server?   @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("containers")
}

// Audit Logs (for tracking actions)
model AuditLog {
  id           Int      @id @default(autoincrement())
  workspaceId  Int      @map("workspace_id")
  userId       Int?     @map("user_id")
  action       String   @db.VarChar(255)
  resourceType String?  @map("resource_type") @db.VarChar(100)
  resourceId   Int?     @map("resource_id")
  details      String?  @db.Text
  ipAddress    String?  @map("ip_address") @db.VarChar(45)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([createdAt])
  @@map("audit_logs")
}

// Workspace Invitations
model WorkspaceInvitation {
  id          Int       @id @default(autoincrement())
  workspaceId Int       @map("workspace_id")
  email       String    @db.VarChar(255)
  token       String    @unique @db.VarChar(255)
  role        String    @default("member") @db.VarChar(50) // admin, member, viewer
  status      String    @default("pending") @db.VarChar(50) // pending, accepted, expired, revoked
  invitedBy   Int       @map("invited_by")
  expiresAt   DateTime  @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  workspace  Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  inviter    User      @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([email])
  @@index([token])
  @@index([status])
  @@map("workspace_invitations")
}

// Workspace Members (Junction table for multi-workspace support)
model WorkspaceMember {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  workspaceId Int      @map("workspace_id")
  role        String   @default("member") @db.VarChar(50) // admin, member, viewer
  joinedAt    DateTime @default(now()) @map("joined_at")

  // Relations
  user      User      @relation("UserMemberships", fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@map("workspace_members")
}

// Network Traffic Hourly Aggregates (for traffic pattern analysis)
model NetworkTrafficHourly {
  id            Int      @id @default(autoincrement())
  serverId      Int      @map("server_id")
  hourTimestamp DateTime @map("hour_timestamp")
  avgInMbps     Decimal  @default(0) @map("avg_in_mbps") @db.Decimal(10, 2)
  avgOutMbps    Decimal  @default(0) @map("avg_out_mbps") @db.Decimal(10, 2)
  maxInMbps     Decimal  @default(0) @map("max_in_mbps") @db.Decimal(10, 2)
  maxOutMbps    Decimal  @default(0) @map("max_out_mbps") @db.Decimal(10, 2)
  minInMbps     Decimal  @default(0) @map("min_in_mbps") @db.Decimal(10, 2)
  minOutMbps    Decimal  @default(0) @map("min_out_mbps") @db.Decimal(10, 2)
  totalInMb     Decimal  @default(0) @map("total_in_mb") @db.Decimal(12, 2)
  totalOutMb    Decimal  @default(0) @map("total_out_mb") @db.Decimal(12, 2)
  samplesCount  Int      @default(0) @map("samples_count")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  server Server @relation(fields: [serverId], references: [id], onDelete: Cascade)

  @@unique([serverId, hourTimestamp], name: "network_traffic_hourly_server_hour_unique")
  @@index([serverId], name: "network_traffic_hourly_server_id_idx")
  @@index([hourTimestamp(sort: Desc)], name: "network_traffic_hourly_timestamp_idx")
  @@map("network_traffic_hourly")
}
